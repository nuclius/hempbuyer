function getDaysInMonth(e,r){var s=new Date(r,e,1),t=[];for(console.log("month",e,"date.getMonth()",s.getMonth());s.getMonth()===e;)t.push(new Date(s)),s.setDate(s.getDate()+1);return t}var nsmarty=require("nsmarty"),util=require("util"),scriptfile="",headered=1,q=require("q"),dateformatServer=require("dateformat"),mysqli=require("./mysqli"),module=require("../module"),fs=require("fs"),jwt=require("jwt-simple"),faAPI=require("../module/forwardauction_api"),profile=require("../module/profile_settings"),membership=require("../module/membership"),async=require("async"),url=require("url");exports.changeDateFormat=function(e){console.log(e);var r=new Date(e.split("/").reverse().join("-"));console.log(r);var s=r.getDate(),t=r.getMonth()+1,o=r.getFullYear()+"/"+t+"/"+s;return console.log(o),o},exports.validateDates=function(e){var r=[];return"weekly"==e?(r.str="week",r.count=1,r):"biweekly"==e?(r.str="week",r.count=2,r):"monthly"==e?(r.str="month",r.count=1,r):"quaterly"==e?(r.str="month",r.count=3,r):"bianually"==e?(r.str="month",r.count=6,r):"anually"==e?(r.str="month",r.count=12,r):void 0},exports.calulatePrice=function(e,r,s){return!1},Date.prototype.addDays=function(e){var r=this.getTime(),s=new Date(r+864e5*e);return this.setDate(s.getDate()),s},exports.sendJSONOutput=function(e,r,s){return r.send(JSON.stringify(s)),r.end(),!1},exports.checkLoginJSON=function(e,r){var s={};if(s.success=!0,void 0===e.session?s.success=!1:void 0===e.session.userid&&(s.success=!1),s.success)return s;this.sendJSONOutput(e,r,s)},exports.getLocations=function(e,r,s){$mysqli={},strQuery=mysqli.mysqli($mysqli,"country_list");var t=s.defer();return query=r.query(strQuery,t.makeNodeResolver()),t.promise},exports.getState=function(e,r,s){$mysqli={},strQuery=mysqli.mysqli($mysqli,"state_list");var t=s.defer(),o=[e.body.cid];return query=r.query(strQuery,o,t.makeNodeResolver()),query.on("error",function(e){throw e}),t.promise},exports.getStateAbbr=function(e,r,s,t){$mysqli={},strQuery=mysqli.mysqli($mysqli,"state_abbr");var o=s.defer(),n=[t];return query=r.query(strQuery,n,o.makeNodeResolver()),console.log(query.sql),query.on("error",function(e){throw e}),o.promise},exports.getbusirestrictions=function(e,r,s){$mysqli={},strQuery=mysqli.mysqli($mysqli,"get_business_settings");var t=s.defer();return query=r.query(strQuery,t.makeNodeResolver()),query.on("error",function(e){throw e}),t.promise},exports.demoFormSubmit=function(e,r,s){$mysqli={};require("dateformat");datge=new Date;var t=[e.body.first_name,e.body.last_name,e.body.email,e.body.address,e.body.country_code,datge];strQuery=mysqli.mysqli($mysqli,297);var o=s.defer();return query=r.query(strQuery,t,o.makeNodeResolver()),o.promise},exports.productQuestion=function(e,r,s){$mysqli={};var t=[e.body.pid];strQuery=mysqli.mysqli($mysqli,259);var o=s.defer();return query=r.query(strQuery,t,o.makeNodeResolver()),o.promise},exports.categoriesAllQuestion=function(e,r,s){$mysqli={},strQuery=mysqli.mysqli($mysqli,257);var t=s.defer(),o=[e.param("cid"),e.param("cid")];return query=r.query(strQuery,o,t.makeNodeResolver()),t.promise},exports.checkPermission=function(e,r){return 1==r.session[e]&&1==r.session.permission&&"active"==r.session.membershipstatus},exports.checkLimitReached=function(e,r){if("monthly_bid_limit"==e)var s=r.session.bidcountmonth;if("bid_limit"==e)s=r.session.bidcountyear;if("monthly_project_limit"==e)s=r.session.productcountmonth;if("project_limit"==e)s=r.session.productcountyear;if("monthly_buynow_limit"==e)s=r.session.buynowcountmonth-1;if("buynow_limit"==e)s=r.session.buynowcountyear;return-1==s&&(s=1),"null"===s&&(s=0),r.session[e]>s||-1==r.session[e]},exports.allCategoriesList=function(e,r,s){$mysqli={},strQuery=mysqli.mysqli($mysqli,175);var t=s.defer();return query=r.query(strQuery,[],t.makeNodeResolver()),t.promise},exports.allStoreCategoriesList=function(e,r,s){$mysqli={},strQuery=mysqli.mysqli($mysqli,10175);var t=s.defer();return query=r.query(strQuery,[],t.makeNodeResolver()),t.promise},exports.admincpId=function(e,r,s){$mysqli={},strQuery=mysqli.mysqli($mysqli,166);var t=s.defer();return query=r.query(strQuery,[["id","email"]],t.makeNodeResolver()),t.promise},exports.randomNumber=function(e,r){var s=require("crypto");r=r||"1234567890";for(var t=s.randomBytes(e),o=new Array(e),n=r.length,i=0;i<e;i++)o[i]=r[t[i]%n];return o.join("")},exports.urlparameter=function(e,r){var s="";for(var t in e)""!=t&&(s+=t+"="+e[t]+"&");for(var o in r)""!=o&&(s=s.replace(new RegExp(o+"="+e[t]+"&","g"),""));return s},exports.SearchPageNo=function(e,r,s){return delete data,data=odata=[],data=url.parse(e.url,!0).query,data.where="",data.dspage=void 0!==e.param("page")?e.param("page"):1,data},exports.fetchCountries=function(e){$mysqli={},strQuery=mysqli.mysqli($mysqli,267);var r=q.defer();return query=e.query(strQuery,[0],r.makeNodeResolver()),r.promise},exports.fetchStates=function(e,r){$mysqli={},strQuery=mysqli.mysqli($mysqli,268);var s=q.defer(),t=[r];return query=e.query(strQuery,t,s.makeNodeResolver()),s.promise},exports.fetchCities=function(e,r){$mysqli={},strQuery=mysqli.mysqli($mysqli,268);var s=q.defer(),t=[r];return query=e.query(strQuery,t,s.makeNodeResolver()),s.promise},exports.processIndex=function(e,r,s,t){t.projects=e,t.loged=r.session,""==t.pagetitle?module.index(r,s,t):module.other(r,s,t)},exports.processIndexajax=function(e,r,s,t){t.proj=e.projects,module.otherAjax(r,s,t)},exports.checkmobile=function(e,r,s){if(0==s){var t="0";return r.send({status:t,msg:"Not Valid User"}),r.end(),!1}try{var o=jwt.decode(s,"123456");if(e.session.username!=o){t="0";return r.send({status:t,msg:"Not Valid User"}),r.end(),!1}return!0}catch(e){if(e){t="0";return r.send({status:t,msg:"Not Valid User"}),r.end(),!1}}},exports.checkLogin=function(e,r,s){return void 0===e.session&&0==s?(e.headers.referer&&r.writeHead(302,{Location:"/login"}),r.end(),!1):void 0===e.session.userid&&0==s?(r.writeHead(302,{Location:"/login"}),r.end(),!1):!(e.session.userid>0&&1==s)||(r.writeHead(302,{Location:"/"}),r.end(),!0)},exports.checkLoginCB=function(e,r,s,t){return void 0===e.session&&0==s?(e.headers.referer&&r.writeHead(302,{Location:"/login"}),r.end(),t(!1),!1):void 0===e.session.userid&&0==s?(r.writeHead(302,{Location:"/"}),r.end(),t(!1),!1):e.session.userid>0&&1==s?(r.writeHead(302,{Location:"/"}),r.end(),t(!1),!0):void 0},exports.admincheckLogin=function(e,r,s){return void 0===e.session&&0==s?(r.writeHead(302,{Location:"/admin/login"}),r.end(),!1):void 0===e.session.userid&&0==s?(r.writeHead(302,{Location:"/admin/login"}),r.end(),!1):e.session.userid>0&&1==s&&1==e.session.admin||(r.writeHead(302,{Location:"/admin/login/"}),r.end(),!1)},exports.checkLoginajax=function(e,r,s){return(void 0!==e.session||0!=s)&&(void 0!==e.session.userid||0!=s)},exports.productCategories=function(e,r){$mysqli={},strQuery=mysqli.mysqli($mysqli,5);var s=r.defer();return query=e.query(strQuery,s.makeNodeResolver()),s.promise},exports.locations=function(e,r,s){$mysqli={},strQuery=mysqli.mysqli($mysqli,702);var t=s.defer();return query=r.query(strQuery,t.makeNodeResolver()),t.promise},exports.tplFile=function(e){this.scriptfile=e},exports.headerSet=function(e){this.headered=e},exports.ajaxjson=function(e,r){e.setHeader("Content-Type","application/json"),e.end(JSON.stringify(r))},exports.loadTemplateHeader=function(e,r,s){var t=this;s.file=this.scriptfile,s.headered=this.headered,s.loged=e.session,s.commonfunction=this,s.sumFloat=this.sumFloat,s.subFloat=this.subFloat,s.parseFloat=this.parseFloat,s.loged.phonevalid=void 0===e.session.phonevalid?"":e.session.phonevalid,s.last_urls=e.protocol+"://"+e.get("host")+e.originalUrl;var o=require("./user"),n=e.protocol+"://"+e.get("host")+e.originalUrl;n=n.replace(/\/$/,""),console.log("------------------ accessed url : "+n);var a=require("useragent"),l=require("request-ip").getClientIp(e),u=a.parse(e.headers["user-agent"]);if(void 0!==e.session.userid?q.all([o.checkuser(e,$arr.config.mysql,q,l)]).then(function(r){r[0][0].length>0?o.updateUser(e,config.mysql,q,l,e.session.userid,e.originalUrl,u.toAgent(),u.os.toString()):o.insertUser(e,config.mysql,q,l,e.session.userid,e.originalUrl,u.toAgent(),u.os.toString())}):q.all([o.checkuser(e,$arr.config.mysql,q,l)]).then(function(r){r[0][0].length>0?o.updateUser(e,config.mysql,q,l,0,e.originalUrl,u.toAgent(),u.os.toString()):o.insertUser(e,config.mysql,q,l,0,e.originalUrl,u.toAgent(),u.os.toString())}),void 0!==e.session.themeno?s.themeno=e.session.themeno:(e.session.themeno=0,s.themeno=e.session.themeno),void 0!==e.session.autologin?s.autologin=e.session.autologin:(e.session.autologin=0,s.autologin=e.session.autologin),s.nuller=null,void 0!==e.param("ln")&&(e.session.language=e.param("ln")),void 0===s.datenow){require("dateformat");s.datenow=new Date}s.serverdate=dateformatServer(new Date,"yyyy/mm/dd HH:MM:ss"),uid=0,void 0!==e.session&&void 0!==e.session.userid&&(uid=e.session.userid),s.ads_page_show=global.ads_page_show,s.adsclickamount=global.ads.clickamount,s.currencyConverter=this.currencyConverter,s.convertKbToMb=this.convertKbToMb,s.shorten=this.shorten,s.convertBytesToKb=this.convertBytesToKb,async.series({getProductCategories:function(e){q.all([t.productCategories(s.config.mysql,q)]).then(function(r){e(null,r)}).fail(function(e){throw console.log(e.stack),e}).done()},getUserInfo:function(r){faAPI.userInfo(e,uid,function(e,s){r(null,s)})},notifyMsgCounter:function(r){q.all([o.notify_msg_counter(e,s.config.mysql,q)]).then(function(e){r(null,e)}).fail(function(e){throw console.log(e.stack),e}).done()},checkCurrency:function(r){q.all([o.checkcurrency(e,s.config.mysql,q)]).then(function(e){r(null,e)}).fail(function(e){throw console.log(e.stack),e}).done()},getSeoFromUrl:function(r){q.all([o.getseofromurl(e,s.config.mysql,q,n)]).then(function(e){r(null,e)}).fail(function(e){console.log(e.stack)}).done()},getStaxDetails:function(r){q.all([profile.staxDetails(e,config.mysql,q,e.session.userid)]).then(function(e){r(null,e)}).fail(function(e){console.log(e.stack)}).done()},getMembership:function(r){q.all([membership.getUserMembership(e,config.mysql,q,e.session.userid)]).then(function(e){r(null,e)}).fail(function(e){console.log(e.stack)}).done()}},function(o,n){function a(e,r,s){return s.indexOf(e)===r}if(o)console.log(o);else{var l=require("fs"),u=require("ini").parse(l.readFileSync("./config.ini","utf-8")),c=u.section.mode.Maintenance_mode,d=u.section.seo.enabled,m=e.originalUrl;s.pageofjs=e.originalUrl;if(m.search("admin")<1&&"yes"==c&&"/"!=m)return r.writeHead(302,{Location:"/"}),r.end(),!1;(m.indexOf("/dashboard")>-1||"/profile_settings"==m)&&(s.pageofjs="/dashboard/"),s.category=n.getProductCategories[0][0],cats=n.getProductCategories[0][0];var y=[],f=[];cats.forEach(function(e){0==e.parent_id&&y.push(e)}),cats.forEach(function(e){e.parent_id>0&&f.push(e)}),s.maincategory=y,s.subcategory=f;var p=require("dateformat");if(s.dateFormat=p,s.seomode=d,s.msgcount=n.notifyMsgCounter[0][0][0].msgs,s.currency=n.checkCurrency[0][0][0].symbol,s.phrases=global.phrases,s.phrase=global.phrase,e.session.currencyrate=n.checkCurrency[0][0][0].rate,s.userbalance=[],0!=uid&&(s.loged.country=n.getUserInfo.user.country,s.loged.state=n.getUserInfo.user.state,s.loged.state_abbr=n.getUserInfo.user.state_abbr,e.session.country=n.getUserInfo.user.country,e.session.state=n.getUserInfo.user.state,""==n.getUserInfo.user.state_abbr&&1!=uid?q.all(t.getStateAbbr("",config.mysql,q,e.session.state)).then(function(r){$arr.loged.state_abbr=e.session.state_abbr=r[0][0].sc}).fail(function(e){throw console.log(e.stack),e}):e.session.state_abbr=n.getUserInfo.user.state_abbr),null!==n.getUserInfo&&void 0!==n.getUserInfo.user&&(s.userbalance.balance=n.getUserInfo.user.balance,s.userbalance.reserve_amount=n.getUserInfo.user.reserve_amount),n.getSeoFromUrl[0].length>0&&(s.metas=n.getSeoFromUrl[0][0]),s.metatitle="sadasdas",uid>0?(s.userbalance.ledger=parseFloat(n.getUserInfo.user.balance-n.getUserInfo.user.reserve_amount).toFixed(2),s.userbalance.balance=parseFloat(n.getUserInfo.user.balance).toFixed(2)):(s.userbalance=[],s.userbalance.ledger=s.userbalance.balance=0),s.userbalance.balance=parseFloat(s.userbalance.balance).toFixed(2),n.getStaxDetails[0][0].length>0&&(e.session.stax=n.getStaxDetails[0][0][0].stax,e.session.stax_per=n.getStaxDetails[0][0][0].stax_per,e.session.business_type=n.getStaxDetails[0][0][0].business_type,s.loged.stax=n.getStaxDetails[0][0][0].stax,s.loged.stax_per=n.getStaxDetails[0][0][0].stax_per,s.loged.business_type=n.getStaxDetails[0][0][0].business_type),n.getMembership[0][0].length>0){var g=n.getMembership[0][0],h=n.getMembership[0][0][0].membership_status;g.length>0&&(e.session.permission=!0,e.session.membershipstatus=h,s.permission=!0,s.membershipstatus=h);for(i in g)e.session[g[i].varname]=g[i].value,s[g[i].varname]=g[i].value}if(nsmarty.tpl_path=s.config.path+"/templates/",void 0!==e.session.language&&(nsmarty.tpl_path=s.config.path+"language/templates/"),nsmarty.clearCache(s.file),s.headered){if(delete defaultcss,defaultcss=["parsley"],void 0!==s.externalcss?(s.external2css=s.externalcss.concat(defaultcss).filter(a),delete s.externalcss):s.external2css=defaultcss,delete defaultjs,defaultjs=["parsley"],void 0!==s.externaljs?(s.external2js=s.externaljs.concat(defaultjs).filter(a),delete s.externaljs):s.external2js=defaultjs,s.timer=0,void 0!==e.session.pid){var v=require("moment"),b=(p=require("dateformat"))(new Date,"yyyy-mm-dd HH:MM:ss"),x=v(e.session.temp_time_id,"YYYY-M-DD HH:mm:ss"),_=v(b,"YYYY-M-DD HH:mm:ss"),F=e.session.timer-_.diff(x,"seconds");s.timer=F}r.setHeader("Content-Type","text/html; charset=UTF-8"),stream=nsmarty.assign(s.file,s),stream.pipe(r)}else stream=nsmarty.assigndata(s.file,s,function(e){r.setHeader("Content-Type","application/json"),r.json({html:e}),r.end()})}})},exports.renderJson=function(e,r){console.log("renderJson section"),e.setHeader("Content-Type","application/json"),e.end(JSON.stringify(r))},exports.currencyConverter=function(e){return parseFloat(e).toFixed(2)},exports.shorten=function(e,r){if(""==e||null==e)return e;var s=e.length,t=require("string");return s>r?t(e).stripTags().s.substring(0,r)+"...":t(e).stripTags().s},exports.parseFloat=function(e){return e=parseFloat(e).toFixed(2),parseFloat(e)},exports.sumFloat=function(e,r){return e=parseFloat(e)+parseFloat(r),parseFloat(e)},exports.subFloat=function(e,r){return e=(parseFloat(e)-parseFloat(r)).toFixed(2),parseFloat(e)},exports.convertBytesToKb=function(e){return kbvalue=(parseFloat(e)/1024).toFixed(2),kbvalue},exports.convertKbToMb=function(e){return kbvalue=(parseFloat(e)/1024).toFixed(2),kbvalue},exports.convertMbToKb=function(e){return mbvalue=(1e3*parseFloat(e)).toFixed(2),mbvalue},exports.dateMeasure=function(e){var r,s,t,o;return o=Math.floor(e/1e3),t=Math.floor(o/60),o%=60,s=Math.floor(t/60),t%=60,r=Math.floor(s/24),s%=24,t=t<10?"0"+t:t,s=s<10?"0"+s:s,o=o<10?"0"+o:o,(r=r<10?"0"+r:r)+"d:"+s+"h:"+t+"m:"+o+"s"},exports.categoryDropdown=function(e){$mysqli={},strQuery=mysqli.mysqli($mysqli,"cat1");var r=q.defer();return query=e.query(strQuery,[0],r.makeNodeResolver()),query.on("error",function(e){throw e}),r.promise},exports.productSubCategories=function(e,r){$mysqli={},strQuery=mysqli.mysqli($mysqli,"cat2");var s=q.defer(),t=[r];return query=e.query(strQuery,t,s.makeNodeResolver()),query.on("error",function(e){throw e}),s.promise},exports.firstLetterCapital=function(e){return e.replace(/\b./g,function(e){return e.toUpperCase()})},exports.last_url=function(e){return e.headers.referer},exports.getAdminphrase=function(e){$mysqli={},strQuery=mysqli.mysqli($mysqli,"get_admin_phrase");var r=q.defer();return query=e.query(strQuery,[],r.makeNodeResolver()),query.on("error",function(e){throw e}),r.promise},exports.getHomephrase=function(e){$mysqli={},strQuery=mysqli.mysqli($mysqli,"get_home_phrase");var r=q.defer();return query=e.query(strQuery,[],r.makeNodeResolver()),query.on("error",function(e){throw e}),r.promise},exports.getExpiredMemberships=function(e){$mysqli={},strQuery=mysqli.mysqli($mysqli,"get_expired_memberships");var r=q.defer();return query=e.query(strQuery,[],r.makeNodeResolver()),console.log(query.sql),query.on("error",function(e){throw e}),r.promise},exports.changeMembershipStatus=function(e,r){console.log(r);var s=[];if(r.length>0)for(i in r)r.length-1==i?s+=r[i]:s=s+r[i]+", ";console.log("idss :------ "+s),$mysqli={ids:s},strQuery=mysqli.mysqli($mysqli,"change_membership_status");var t=q.defer();return query=e.query(strQuery,[],t.makeNodeResolver()),console.log(query.sql),query.on("error",function(e){throw e}),t.promise},exports.addDecimalPlaces=function(e,r){if(req_data=[],"users"==e){for(var s in r)r[s].balance=parseFloat(r[s].balance).toFixed(2);return r}if("funds_requests"==e){for(var s in r)r[s].amount=parseFloat(r[s].amount).toFixed(2),r[s].balance=parseFloat(r[s].balance).toFixed(2);return r}if("buynow_rec"==e){console.log("roundoff in common");for(var s in r)console.log(r[s].b_cancel_ins_amt),console.log(r[s].b_cancel_ins_per),r[s].b_cancel_ins_amt=parseFloat(r[s].b_cancel_ins_amt).toFixed(2),r[s].b_cancel_ins_per=parseFloat(r[s].b_cancel_ins_per).toFixed(2),r[s].b_total_amount=parseFloat(r[s].b_total_amount).toFixed(2);return r}if("seller_sold"==e){for(var s in r)r[s].b_total_amount=parseFloat(r[s].b_total_amount).toFixed(2);return r}};